<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–®–∫—ñ–ª—å–Ω–µ –º–µ–Ω—é</title>
  <style>
    /* üëá –°–í–Ü–¢–õ–ê –¢–ï–ú–ê (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) */
    :root {
      --bg: #f7fbff;
      --card: #ffffff;
      --accent: #0066cc;
      --muted: #6b7280;
      --text: #0f172a;
      --border: rgba(11,56,110,0.04);
      --shadow: rgba(12,18,40,0.06);
      --reaction-bg: #f1f5f9;
      --like-color: #22c55e;
      --dislike-color: #ef4444;
      --today-badge: #3b82f6;
    }

    /* üëá –¢–ï–ú–ù–ê –¢–ï–ú–ê */
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #3b82f6;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --border: rgba(148,163,184,0.1);
      --shadow: rgba(0,0,0,0.3);
      --reaction-bg: #334155;
      --like-color: #4ade80;
      --dislike-color: #f87171;
      --today-badge: #60a5fa;
    }

    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Arial; background:var(--bg); margin:0; padding:24px; color:var(--text); transition:background 0.3s, color 0.3s}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px}
    h1{font-size:20px;margin:0}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:opacity 0.2s}
    button:hover{opacity:0.9}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,102,204,0.12)}
    button:disabled{opacity:0.6;cursor:not-allowed}
    .date-display{font-weight:700}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px var(--shadow);transition:background 0.3s, box-shadow 0.3s}
    .section-title{font-weight:700;margin-top:14px;margin-bottom:8px;color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .meal{padding:12px;border-radius:8px;background:var(--card);border:1px solid var(--border);position:relative;transition:all 0.3s}
    .meal h4{margin:0 0 6px 0;font-size:15px;color:var(--text)}
    .muted{color:var(--muted);font-size:13px}
    .form-row{margin-top:8px}
    textarea,input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);font-size:14px;background:var(--card);color:var(--text)}
    .status{padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px}
    .success{background:#d4edda;color:#155724}
    .loading{background:#fff3cd;color:#856404}
    .error{background:#f8d7da;color:#721c24}
    .access-panel{background:var(--reaction-bg);padding:15px;border-radius:8px;margin-top:15px;border:1px dashed var(--border)}
    .user-badge{background:#e7f3ff;padding:4px 8px;border-radius:4px;font-size:12px;margin-left:8px}

    /* üëá –ö–ù–û–ü–ö–ê –¢–ï–ú–ò */
    .theme-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
    }
    .theme-toggle:hover {
      transform: scale(1.05);
    }

    /* üëá –†–ï–ê–ö–¶–Ü–á */
    .reactions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }
    
    .reaction-btn {
      background: var(--reaction-bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
      color: var(--text);
    }
    
    .reaction-btn:hover {
      transform: scale(1.05);
    }
    
    .reaction-btn.active {
      font-weight: bold;
    }
    
    .reaction-btn.like.active {
      background: var(--like-color);
      color: white;
      border-color: var(--like-color);
    }
    
    .reaction-btn.dislike.active {
      background: var(--dislike-color);
      color: white;
      border-color: var(--dislike-color);
    }
    
    .reaction-count {
      font-size: 12px;
      color: var(--muted);
      margin-left: 4px;
      font-weight: bold;
    }
    
    .today-badge {
      position: absolute;
      top: -8px;
      right: 10px;
      background: var(--today-badge);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 1;
    }

    .meal-content {
      white-space: pre-line;
      line-height: 1.5;
    }

    @media(max-width:520px){
      header{flex-direction:column;align-items:flex-start}
      .controls{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üçΩÔ∏è –®–∫—ñ–ª—å–Ω–µ –º–µ–Ω—é</h1>
        <div class="muted small">–ü–æ–∫–∞–∑–∞–Ω–æ –º–µ–Ω—é –Ω–∞ <span id="readableDate">...</span> <span id="status" class="status"></span></div>
      </div>
      <div class="controls">
        <button id="themeToggle" class="theme-toggle">üåô</button>
        <button id="prev" class="ghost">‚Üê</button>
        <input type="date" id="date" />
        <button id="next" class="ghost">‚Üí</button>
        <button id="today">–°—å–æ–≥–æ–¥–Ω—ñ</button>
        <button id="refresh">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        <button id="adminToggle" class="ghost">‚öôÔ∏è –ê–¥–º—ñ–Ω</button>
        <span id="userBadge" class="user-badge" style="display:none">üë§ –ê–¥–º—ñ–Ω</span>
      </div>
    </header>

    <main class="card">
      <div class="section-title">üè´ –ú—ñ—Å—å–∫—ñ –¥—ñ—Ç–∏</div>
      <div id="cityArea" class="grid" aria-live="polite"></div>

      <div class="section-title">üè† –Ü–Ω–æ–≥–æ—Ä–æ–¥–Ω—ñ –¥—ñ—Ç–∏</div>
      <div id="nonCityArea" class="grid" aria-live="polite"></div>

      <div id="adminSection" style="margin-top:30px;padding-top:20px;border-top:1px solid var(--border)">
        <div style="text-align:center;margin-bottom:15px;">
          <button id="toggleAdminPanel" class="ghost" style="font-size:12px;">üë®‚Äçüè´ –†–æ–∑–¥—ñ–ª –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</button>
        </div>
        
        <div id="accessPanel" class="access-panel" style="display:none">
          <h3>üîê –î–æ—Å—Ç—É–ø –¥–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è</h3>
          <div class="form-row">
            <label>–ü–∞—Ä–æ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</label>
            <input type="password" id="adminPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" style="width:100%" />
          </div>
          <button id="loginBtn">üîì –£–≤—ñ–π—Ç–∏</button>
          <div class="muted" style="margin-top:8px;font-size:12px">
            –°–∞–π—Ç –ø—Ä–∏–≤–∞—Ç–Ω–∏–π. –ü–∞—Ä–æ–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å –ø—ñ–¥ —Ç–∏—Å–∫–æ–º
          </div>
        </div>

        <div id="editor" style="display:none;margin-top:20px;padding:20px;background:var(--reaction-bg);border-radius:8px;">
          <h3>‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–µ–Ω—é –Ω–∞ <span id="editDateLabel"></span></h3>
          
          <div class="muted" style="margin-bottom:15px;">
            üí° –ó–º—ñ–Ω–∏ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–ª—è –≤—Å—ñ—Ö –≤—ñ–¥–≤—ñ–¥—É–≤–∞—á—ñ–≤ —Å–∞–π—Ç—É
          </div>
          
          <div class="section-title">üçΩÔ∏è –ú—ñ—Å—å–∫—ñ –¥—ñ—Ç–∏</div>
          <div class="form-row"><label>üç≤ –û–±—ñ–¥</label><textarea id="e_city_lunch" rows="3" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ë–æ—Ä—â, –∫–æ—Ç–ª–µ—Ç–∞, –ø—é—Ä–µ, –∫–æ–º–ø–æ—Ç"></textarea></div>

          <div class="section-title">üè† –Ü–Ω–æ–≥–æ—Ä–æ–¥–Ω—ñ –¥—ñ—Ç–∏</div>
          <div class="form-row"><label>üç≥ –°–Ω—ñ–¥–∞–Ω–æ–∫</label><textarea id="e_nc_breakfast" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–∞—à–∞ –≥—Ä–µ—á–∞–Ω–∞, –±—É—Ç–µ—Ä–±—Ä–æ–¥, —á–∞–π"></textarea></div>
          <div class="form-row"><label>üçé –ü–æ–ª—É–¥–µ–Ω–æ–∫</label><textarea id="e_nc_snack" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –Ø–±–ª—É–∫–æ, –ø–µ—á–∏–≤–æ, —Å—ñ–∫"></textarea></div>
          <div class="form-row"><label>üç≤ –û–±—ñ–¥</label><textarea id="e_nc_lunch" rows="3" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ë–æ—Ä—â, –∫–æ—Ç–ª–µ—Ç–∞, –ø—é—Ä–µ, —Å–∞–ª–∞—Ç"></textarea></div>
          <div class="form-row"><label>ü•õ –ü—ñ–¥–≤–µ—á—ñ—Ä–æ–∫</label><textarea id="e_nc_evening" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ô–æ–≥—É—Ä—Ç, —Ñ—Ä—É–∫—Ç"></textarea></div>
          <div class="form-row"><label>üçõ –í–µ—á–µ—Ä—è</label><textarea id="e_nc_dinner" rows="2" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –û–º–ª–µ—Ç, —Å–∞–ª–∞—Ç, –∫–µ—Ñ—ñ—Ä"></textarea></div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
            <button id="save">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö</button>
            <button id="cancel" class="ghost">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const ADMIN_PASSWORD = "school123123";
    const GITHUB_CONFIG = {
      repoOwner: "Pomasvg",       
      repoName: "menu"
    };

    let currentData = {};
    let isAdmin = false;
    let githubToken = "";
    
    // üëá –†–ï–ê–ö–¶–Ü–á (–±–µ–∑ GitHub - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω–æ)
    let reactionsData = JSON.parse(localStorage.getItem('menu_reactions') || '{}');
    let userId = localStorage.getItem('user_id') || generateUserId();

    function generateUserId() {
      const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('user_id', id);
      return id;
    }

    function saveReactionsToStorage() {
      localStorage.setItem('menu_reactions', JSON.stringify(reactionsData));
    }

    const dateInput = document.getElementById('date');
    const readableDate = document.getElementById('readableDate');
    const cityArea = document.getElementById('cityArea');
    const nonCityArea = document.getElementById('nonCityArea');
    const editor = document.getElementById('editor');
    const statusEl = document.getElementById('status');
    const accessPanel = document.getElementById('accessPanel');
    const userBadge = document.getElementById('userBadge');

    function isoToday() { return new Date().toISOString().slice(0,10); }
    function niceDate(iso) { return new Date(iso).toLocaleDateString('uk-UA',{year:'numeric',month:'long',day:'numeric'}); }

    function setStatus(text, type = '') {
      statusEl.textContent = text;
      statusEl.className = `status ${type}`;
    }

    // üëá –¢–ï–ú–ù–ê/–°–í–Ü–¢–õ–ê –¢–ï–ú–ê
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeButton(savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeButton(newTheme);
    }

    function updateThemeButton(theme) {
      const button = document.getElementById('themeToggle');
      button.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      button.title = theme === 'dark' ? '–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –Ω–∞ —Å–≤—ñ—Ç–ª—É —Ç–µ–º—É' : '–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –Ω–∞ —Ç–µ–º–Ω—É —Ç–µ–º—É';
    }

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    // üëá –§–£–ù–ö–¶–Ü–á –î–õ–Ø –†–ï–ê–ö–¶–Ü–ô (—Å–ø—Ä–æ—â–µ–Ω—ñ)
    function saveReaction(mealType, reaction) {
      const today = isoToday();
      if (!reactionsData[today]) {
        reactionsData[today] = {};
      }
      
      if (!reactionsData[today][mealType]) {
        reactionsData[today][mealType] = { likes: [], dislikes: [] };
      }
      
      // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—É —Ä–µ–∞–∫—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const mealReactions = reactionsData[today][mealType];
      mealReactions.likes = mealReactions.likes.filter(id => id !== userId);
      mealReactions.dislikes = mealReactions.dislikes.filter(id => id !== userId);
      
      // –î–æ–¥–∞—î–º–æ –Ω–æ–≤—É —Ä–µ–∞–∫—Ü—ñ—é
      if (reaction === 'like') {
        mealReactions.likes.push(userId);
      } else if (reaction === 'dislike') {
        mealReactions.dislikes.push(userId);
      }
      
      // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ localStorage
      saveReactionsToStorage();
      return true;
    }

    function getUserReaction(mealType) {
      const today = isoToday();
      if (!reactionsData[today] || !reactionsData[today][mealType]) {
        return null;
      }
      
      const mealReactions = reactionsData[today][mealType];
      if (mealReactions.likes.includes(userId)) return 'like';
      if (mealReactions.dislikes.includes(userId)) return 'dislike';
      return null;
    }

    function getReactionCounts(mealType) {
      const today = isoToday();
      if (!reactionsData[today] || !reactionsData[today][mealType]) {
        return { likes: 0, dislikes: 0 };
      }
      
      const mealReactions = reactionsData[today][mealType];
      return {
        likes: mealReactions.likes.length,
        dislikes: mealReactions.dislikes.length
      };
    }

    // üëá –û–ù–û–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –ú–ï–ù–Æ –ó –†–ï–ê–ö–¶–Ü–Ø–ú–ò
    function renderForDate(iso) {
      if (!iso) iso = dateInput.value || isoToday();
      readableDate.textContent = niceDate(iso);
      const day = currentData[iso] || { city: { lunch: '' }, nonCity: { breakfast:'', snack:'', lunch:'', evening:'', dinner:'' } };
      const isToday = iso === isoToday();

      cityArea.innerHTML = '';
      const cityLunchCard = document.createElement('div');
      cityLunchCard.className = 'meal';
      
      if (isToday) {
        const todayBadge = document.createElement('span');
        todayBadge.className = 'today-badge';
        todayBadge.textContent = '–°–¨–û–ì–û–î–ù–Ü';
        cityLunchCard.appendChild(todayBadge);
      }
      
      const cityContent = document.createElement('div');
      cityContent.innerHTML = `<h4>üçΩÔ∏è –û–±—ñ–¥</h4><div class="meal-content">${day.city.lunch || '‚Äî'}</div>`;
      cityLunchCard.appendChild(cityContent);
      
      if (isToday) {
        const reactions = createReactionsElement('city_lunch');
        cityLunchCard.appendChild(reactions);
      }
      
      cityArea.appendChild(cityLunchCard);

      nonCityArea.innerHTML = '';
      const fields = [
        ['üç≥ –°–Ω—ñ–¥–∞–Ω–æ–∫', 'nc_breakfast', day.nonCity.breakfast],
        ['üçé –ü–æ–ª—É–¥–µ–Ω–æ–∫', 'nc_snack', day.nonCity.snack],
        ['üç≤ –û–±—ñ–¥', 'nc_lunch', day.nonCity.lunch],
        ['ü•õ –ü—ñ–¥–≤–µ—á—ñ—Ä–æ–∫', 'nc_evening', day.nonCity.evening],
        ['üçõ –í–µ—á–µ—Ä—è', 'nc_dinner', day.nonCity.dinner]
      ];
      
      fields.forEach(([title, mealType, val]) => {
        const div = document.createElement('div');
        div.className = 'meal';
        
        if (isToday) {
          const todayBadge = document.createElement('span');
          todayBadge.className = 'today-badge';
          todayBadge.textContent = '–°–¨–û–ì–û–î–ù–Ü';
          div.appendChild(todayBadge);
        }
        
        const content = document.createElement('div');
        content.innerHTML = `<h4>${title}</h4><div class="meal-content">${val || '‚Äî'}</div>`;
        div.appendChild(content);
        
        if (isToday) {
          const reactions = createReactionsElement(mealType);
          div.appendChild(reactions);
        }
        
        nonCityArea.appendChild(div);
      });
    }

    function createReactionsElement(mealType) {
      const userReaction = getUserReaction(mealType);
      const counts = getReactionCounts(mealType);
      
      const reactionsDiv = document.createElement('div');
      reactionsDiv.className = 'reactions';
      
      const likeBtn = document.createElement('button');
      likeBtn.className = `reaction-btn like ${userReaction === 'like' ? 'active' : ''}`;
      likeBtn.innerHTML = `üëç <span class="reaction-count">${counts.likes}</span>`;
      likeBtn.title = "–°–ø–æ–¥–æ–±–∞–ª–æ—Å—è";
      likeBtn.onclick = () => handleReaction(mealType, 'like');
      
      const dislikeBtn = document.createElement('button');
      dislikeBtn.className = `reaction-btn dislike ${userReaction === 'dislike' ? 'active' : ''}`;
      dislikeBtn.innerHTML = `üëé <span class="reaction-count">${counts.dislikes}</span>`;
      dislikeBtn.title = "–ù–µ —Å–ø–æ–¥–æ–±–∞–ª–æ—Å—è";
      dislikeBtn.onclick = () => handleReaction(mealType, 'dislike');
      
      reactionsDiv.appendChild(likeBtn);
      reactionsDiv.appendChild(dislikeBtn);
      
      return reactionsDiv;
    }

    function handleReaction(mealType, reaction) {
      if (dateInput.value !== isoToday()) {
        alert('‚ö†Ô∏è –†–µ–∞–∫—Ü—ñ—ó –º–æ–∂–Ω–∞ —Å—Ç–∞–≤–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—î –º–µ–Ω—é!');
        return;
      }
      
      const success = saveReaction(mealType, reaction);
      if (success) {
        renderForDate(dateInput.value);
      }
    }

    function utf8_to_b64(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
      }));
    }

    async function getGitHubToken() {
      if (githubToken) return githubToken;
      
      const savedToken = localStorage.getItem('github_token');
      if (savedToken) {
        githubToken = savedToken;
        return savedToken;
      }
      
      const token = prompt('üîê –°—é–¥–∏ –≤–≤–µ–¥–∏ —Ç–æ–∫–µ–Ω');
      if (token) {
        const isValid = await validateToken(token);
        if (isValid) {
          githubToken = token;
          localStorage.setItem('github_token', token);
          return token;
        } else {
          alert('‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É.');
          localStorage.removeItem('github_token');
          return null;
        }
      }
      
      return null;
    }

    async function validateToken(token) {
      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    async function loadData() {
      setStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...', 'loading');
      try {
        const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.repoOwner}/${GITHUB_CONFIG.repoName}/main/menu.json`;
        const response = await fetch(url + '?t=' + Date.now());
        
        if (response.ok) {
          const content = await response.json();
          currentData = content;
          setStatus('–û–Ω–æ–≤–ª–µ–Ω–æ', 'success');
          setTimeout(() => setStatus(''), 3000);
          return true;
        } else if (response.status === 404) {
          currentData = {};
          setStatus('–ú–µ–Ω—é —â–µ –Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–µ', 'success');
          return true;
        } else {
          throw new Error(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ${response.status}`);
        }
      } catch (error) {
        setStatus('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è', 'error');
        console.error('–ü–æ–º–∏–ª–∫–∞:', error);
        return false;
      }
    }

    async function saveData() {
      const token = await getGitHubToken();
      if (!token) {
        setStatus('–ü–æ—Ç—Ä—ñ–±–µ–Ω —Ç–æ–∫–µ–Ω –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è', 'error');
        return false;
      }

      setStatus('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...', 'loading');
      try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.repoOwner}/${GITHUB_CONFIG.repoName}/contents/menu.json`;
        
        let sha = '';
        try {
          const getResponse = await fetch(url, {
            headers: {
              'Authorization': `token ${token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (getResponse.status === 401) {
            throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ —Ç–æ–∫–µ–Ω –∑–Ω–æ–≤—É.');
          }
          
          if (getResponse.ok) {
            const fileData = await getResponse.json();
            sha = fileData.sha;
          } else if (getResponse.status !== 404) {
            throw new Error(`–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—É: ${getResponse.status}`);
          }
        } catch (error) {
          if (error.message.includes('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ç–æ–∫–µ–Ω')) {
            localStorage.removeItem('github_token');
            githubToken = "";
            throw error;
          }
          if (!error.message.includes('404')) {
            throw error;
          }
        }

        const jsonString = JSON.stringify(currentData, null, 2);
        const content = utf8_to_b64(jsonString);
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `–û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–µ–Ω—é –∑–∞ ${dateInput.value}`,
            content: content,
            sha: sha || undefined
          })
        });

        if (response.ok) {
          setStatus('–ó–±–µ—Ä–µ–∂–µ–Ω–æ –¥–ª—è –≤—Å—ñ—Ö!', 'success');
          setTimeout(() => setStatus(''), 3000);
          return true;
        } else {
          const errorData = await response.json();
          
          if (response.status === 401) {
            localStorage.removeItem('github_token');
            githubToken = "";
            throw new Error('–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤–∏–π —Ç–æ–∫–µ–Ω.');
          } else if (response.status === 403) {
            throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∞–≤. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ —Ç–æ–∫–µ–Ω –º–∞—î –ø—Ä–∞–≤–∞ "repo".');
          } else if (response.status === 404) {
            throw new Error('–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ repoOwner —Ç–∞ repoName.');
          } else {
            throw new Error(errorData.message || `–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ${response.status}`);
          }
        }
      } catch (error) {
        setStatus(`–ü–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è:', error);
        
        if (error.message.includes('—Ç–æ–∫–µ–Ω') || error.message.includes('–ø—Ä–∞–≤')) {
          setTimeout(() => {
            localStorage.removeItem('github_token');
            githubToken = "";
            getGitHubToken();
          }, 2000);
        }
        
        return false;
      }
    }

    document.getElementById('today').addEventListener('click', () => {
      dateInput.value = isoToday();
      renderForDate(dateInput.value);
    });

    document.getElementById('prev').addEventListener('click', () => changeDateBy(-1));
    document.getElementById('next').addEventListener('click', () => changeDateBy(1));
    document.getElementById('refresh').addEventListener('click', () => {
      loadData().then(() => renderForDate(dateInput.value));
    });

    function changeDateBy(delta) {
      const cur = new Date(dateInput.value || isoToday());
      cur.setDate(cur.getDate() + delta);
      const iso = cur.toISOString().slice(0,10);
      dateInput.value = iso;
      renderForDate(iso);
    }

    dateInput.addEventListener('change', () => renderForDate(dateInput.value));

    document.getElementById('toggleAdminPanel').addEventListener('click', () => {
      accessPanel.style.display = accessPanel.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('adminToggle').addEventListener('click', () => {
      document.getElementById('adminSection').scrollIntoView({ behavior: 'smooth' });
      accessPanel.style.display = 'block';
    });

    document.getElementById('loginBtn').addEventListener('click', () => {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        accessPanel.style.display = 'none';
        userBadge.style.display = 'inline-block';
        document.getElementById('adminToggle').textContent = '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
        alert('‚úÖ –í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä! –¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –º–µ–Ω—é.');
      } else {
        alert('‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å! –ó–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —à–∫–æ–ª–∏.');
      }
    });

    document.getElementById('adminToggle').addEventListener('click', () => {
      if (!isAdmin) {
        document.getElementById('adminSection').scrollIntoView({ behavior: 'smooth' });
        accessPanel.style.display = 'block';
        return;
      }
      openEditorFor(dateInput.value || isoToday());
    });

    function openEditorFor(iso) {
      const day = currentData[iso] || { city: { lunch: '' }, nonCity: { breakfast:'', snack:'', lunch:'', evening:'', dinner:'' } };
      
      document.getElementById('e_city_lunch').value = day.city.lunch || '';
      document.getElementById('e_nc_breakfast').value = day.nonCity.breakfast || '';
      document.getElementById('e_nc_snack').value = day.nonCity.snack || '';
      document.getElementById('e_nc_lunch').value = day.nonCity.lunch || '';
      document.getElementById('e_nc_evening').value = day.nonCity.evening || '';
      document.getElementById('e_nc_dinner').value = day.nonCity.dinner || '';
      document.getElementById('editDateLabel').textContent = niceDate(iso);
      editor.style.display = 'block';
      editor.scrollIntoView({ behavior: 'smooth' });
    }

    document.getElementById('cancel').addEventListener('click', () => {
      editor.style.display = 'none';
    });

    document.getElementById('save').addEventListener('click', async () => {
      const iso = dateInput.value || isoToday();
      
      currentData[iso] = {
        city: { lunch: document.getElementById('e_city_lunch').value.trim() },
        nonCity: {
          breakfast: document.getElementById('e_nc_breakfast').value.trim(),
          snack: document.getElementById('e_nc_snack').value.trim(),
          lunch: document.getElementById('e_nc_lunch').value.trim(),
          evening: document.getElementById('e_nc_evening').value.trim(),
          dinner: document.getElementById('e_nc_dinner').value.trim()
        }
      };

      const success = await saveData();
      if (success) {
        renderForDate(iso);
        editor.style.display = 'none';
      }
    });

    // üëá –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
    (async function init() {
      initTheme();
      dateInput.value = isoToday();
      await loadData();
      renderForDate(dateInput.value);
    })();
  </script>
</body>
</html>
